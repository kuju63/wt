# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**wt** is a Git worktree management CLI tool built with .NET 10.0 and System.CommandLine. It simplifies creating, listing, and managing Git worktrees with optional editor integration.

## Build & Test Commands

```bash
# Build
dotnet build wt.sln --configuration Release

# Run all tests
dotnet test wt.sln

# Run tests with coverage
dotnet test wt.sln --collect:"XPlat Code Coverage"

# Run the CLI (from project root)
dotnet run --project wt.cli -- <command> [options]

# Run a single test file
dotnet test wt.tests --filter "FullyQualifiedName~ClassName"

# Run a single test method
dotnet test wt.tests --filter "FullyQualifiedName~ClassName.MethodName"
```

## Architecture

### Dependency Flow

```
Program.cs (DI setup) → Commands → WorktreeService → GitService/EditorService
                                                   → PathHelper
```

### Key Components

- **Program.cs**: Entry point with manual DI wiring. Instantiates all services and registers commands with RootCommand.

- **Commands/**: System.CommandLine command definitions. Each command inherits from `Command` and takes services via constructor.
  - `CreateCommand`: Creates worktree with new branch
  - `ListCommand`: Lists all worktrees in table/JSON format

- **Services/**: Business logic layer
  - `GitService`: Wraps git CLI operations (worktree add, branch operations, repository checks)
  - `WorktreeService`: Orchestrates worktree creation flow, coordinates git/editor/path services
  - `EditorService`: Launches editors (vscode, vim, emacs, nano, idea)
  - `ProcessRunner`: Executes shell commands, abstracts process spawning

- **Models/**: Data structures
  - `CommandResult<T>`: Result pattern with success/failure, error codes, and solutions
  - `ErrorCodes`: Centralized error code constants (GIT001-003, BR001-003, WT001-002, FS001-003, ED001) with `GetSolution()` method

- **Utils/**: Helpers
  - `PathHelper`: Worktree path resolution using `System.IO.Abstractions`

- **Formatters/**: Output formatting
  - `TableFormatter`: Unicode box-drawing table output for human-readable display

### Testability Pattern

All file system operations use `System.IO.Abstractions` for mockability. Tests use `System.IO.Abstractions.TestingHelpers` and Moq for mocking. Assertions use Shouldly.

## Development Workflow (from AGENTS.md)

This project follows **SDD (Specification-Driven Development)** with **TDD (Test-Driven Development)**:

1. Create/update specification in `specs/<number>-<feature>/spec.md` using Spec Kit
2. Write tests first (Red)
3. Implement minimal code to pass (Green)
4. Refactor while keeping tests green
5. User commits changes (AI provides draft commit message only)

### Spec Kit Installation

```bash
uv tool install specify-cli --from git+https://github.com/github/spec-kit.git
```

## Communication Rules

- **Japanese preferred** for communication; respond in English if queried in English
- **Single question at a time** - don't batch multiple questions
- When presenting technical choices, provide **multiple options with pros/cons**
- **Commit messages in English** following Conventional Commits: `<type>: <subject>`
- Types: `feat`, `fix`, `docs`, `style`, `refactor`, `test`, `chore`

## Documentation Generation

- **Command docs** (`docs/commands/`): Auto-generated from System.CommandLine via `Tools/DocGenerator` - don't edit directly
- **API docs** (`api/`): Auto-generated by DocFX from XML comments - don't edit directly
- **User docs** (`docs/`): Manual markdown files - edit directly

```bash
# Generate command docs
cd Tools/DocGenerator && dotnet run -- ../../docs

# Build all docs
docfx build docfx.json
```

## Code Style

- Use `var` when type is apparent
- Allman brace style (braces on new lines)
- 4-space indentation for C#
- Sort usings with System.* first
- XML documentation for public APIs (English)

<!-- MANUAL ADDITIONS START -->
<!-- MANUAL ADDITIONS END -->
