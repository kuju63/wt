name: Documentation

on:
  release:
    types: [published]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Install DocFX
        run: dotnet tool install docfx --version 2.78.4 --global
      
      - name: Extract version
        id: version
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          # Extract major.minor from tag (e.g., v1.2.3 -> v1.2)
          VERSION=$(echo $TAG_NAME | grep -oE 'v?[0-9]+\.[0-9]+')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
      
      - name: Generate command documentation
        run: dotnet run --project Tools/DocGenerator/DocGenerator -- --output docs/commands
      
      - name: Build documentation
        run: |
          docfx metadata
          docfx build --output _site/${{ steps.version.outputs.version }}
      
      - name: Update version manifest
        run: |
          python3 .github/scripts/update-version-manifest.py _site/versions.json ${{ steps.version.outputs.version }}
          cp _site/versions.json _site/${{ steps.version.outputs.version }}/versions.json
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          keep_files: true



