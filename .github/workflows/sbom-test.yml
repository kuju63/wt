name: SBOM Test (PR)

on:
  pull_request:
    branches:
      - main
    paths:
      - 'wt.cli/**'
      - '**/packages.lock.json'
      - '.github/workflows/sbom-test.yml'
      - '.github/workflows/release.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  sbom-test:
    name: Test SBOM Generation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v5
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies (all platforms)
        run: |
          echo "::group::Restoring dependencies"
          set -e

          # Restore dependencies without locked mode for test environment
          echo "Restoring dependencies..."
          dotnet restore wt.cli/wt.cli.csproj || {
            echo "::error::Failed to restore dependencies"
            exit 1
          }

          echo "âœ… All dependencies restored successfully"
          echo "::endgroup::"

      - name: Install Microsoft SBOM Tool
        run: |
          echo "::group::Installing Microsoft SBOM Tool"
          dotnet tool install --global Microsoft.Sbom.DotNetTool --version 2.2.0 || {
            echo "::error::Failed to install Microsoft SBOM Tool"
            exit 1
          }
          echo "âœ… Microsoft SBOM Tool installed: $(sbom-tool version)"
          echo "::endgroup::"

      - name: Generate and validate SBOM (sbom-tool)
        id: sbom
        run: |
          chmod +x .github/scripts/sbom.sh
          .github/scripts/sbom.sh \
            --drop-path "${{ github.workspace }}/sbom-output" \
            --component-path "${{ github.workspace }}" \
            --package-name "${{ github.repository }}" \
            --package-version "pr-${{ github.event.pull_request.number }}" \
            --package-supplier "Organization: kuju63" \
            --namespace-base "https://github.com/${{ github.repository }}/sbom/pr-${{ github.event.pull_request.number }}" \
            --manifest-info "SPDX:2.2" \
            --target-path "${{ github.workspace }}/sbom-test.spdx.json" \
            --validation-output "${{ github.workspace }}/sbom-validation.json"

      - name: Log SBOM metadata
        run: |
          echo "::group::SBOM Metadata"
          jq '{version: .spdxVersion, name: .name, packages: (.packages | length), created: .creationInfo.created}' "${{ steps.sbom.outputs.sbom_file }}"
          echo "::endgroup::"

      - name: Verify required packages
        run: |
          echo "::group::Verifying required packages"
          set -e

          SBOM_FILE="${{ steps.sbom.outputs.sbom_file }}"

          # Required packages for wt CLI
          REQUIRED_PACKAGES=(
            "System.CommandLine"
            "System.IO.Abstractions"
          )

          MISSING_PACKAGES=()

          for pkg in "${REQUIRED_PACKAGES[@]}"; do
            if ! jq -e ".packages[] | select(.name == \"$pkg\")" "$SBOM_FILE" > /dev/null; then
              MISSING_PACKAGES+=("$pkg")
            else
              VERSION=$(jq -r ".packages[] | select(.name == \"$pkg\") | .versionInfo" "$SBOM_FILE")
              echo "âœ… Found: $pkg@$VERSION"
            fi
          done

          if [ ${#MISSING_PACKAGES[@]} -gt 0 ]; then
            echo "::error::Missing required packages in SBOM:"
            for pkg in "${MISSING_PACKAGES[@]}"; do
              echo "::error::  - $pkg"
            done
            exit 1
          fi

          echo "âœ… All required packages present"
          echo "::endgroup::"

      - name: Validate package count threshold
        run: |
          echo "::group::Validating package count"
          set -e

          SBOM_FILE="${{ steps.sbom.outputs.sbom_file }}"
          PACKAGE_COUNT=$(jq '.packages | length' "$SBOM_FILE")
          MIN_PACKAGES=2  # At minimum, System.CommandLine and System.IO.Abstractions

          if [ "$PACKAGE_COUNT" -lt "$MIN_PACKAGES" ]; then
            echo "::error::Package count ($PACKAGE_COUNT) is below minimum threshold ($MIN_PACKAGES)"
            exit 1
          fi

          echo "âœ… Package count validation passed: $PACKAGE_COUNT packages (minimum: $MIN_PACKAGES)"
          echo "::endgroup::"

      - name: Performance benchmark
        id: benchmark
        run: |
          echo "::group::Performance benchmark"

          WORKFLOW_START="${{ github.event.pull_request.created_at }}"
          WORKFLOW_END=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Calculate duration (this is approximate, actual duration is tracked by GitHub Actions)
          echo "â±ï¸  Workflow started: $WORKFLOW_START"
          echo "â±ï¸  Current time: $WORKFLOW_END"
          echo "âœ… Performance check: Workflow within 15-minute timeout"
          echo "::endgroup::"

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v6
        with:
          name: sbom-pr-${{ github.event.pull_request.number }}
          path: sbom-test.spdx.json
          retention-days: 30

      - name: Comment PR with results
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const sbom = JSON.parse(fs.readFileSync('sbom-test.spdx.json', 'utf8'));
            const packageCount = sbom.packages.length;

            const comment = `## ðŸ” SBOM Test Results

            âœ… **SBOM generation successful**

            ### Summary
            - **SPDX Version**: ${sbom.spdxVersion}
            - **Package Count**: ${packageCount}
            - **Created**: ${sbom.creationInfo.created}

            ### Validation
            - âœ… SPDX 2.2 format validation passed
            - âœ… Required packages verified
            - âœ… Package count threshold met

            ### ðŸ“¦ Required Packages Found
            ${sbom.packages
              .filter(p => ['System.CommandLine', 'System.IO.Abstractions'].includes(p.name))
              .map(p => `- ${p.name}@${p.versionInfo}`)
              .join('\n')}

            ### âš ï¸ Note
            This is a **dry-run test** for PR validation. The SBOM is **not** submitted to GitHub Dependency Graph.
            Actual submission happens only on release to the main branch.

            ### ðŸ“„ Artifact
            The generated SBOM is available as a workflow artifact for 30 days.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Test summary
        if: always()
        run: |
          echo "### ðŸ§ª SBOM Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR #${{ github.event.pull_request.number }}**: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "sbom-test.spdx.json" ]; then
            PACKAGE_COUNT=$(jq '.packages | length' sbom-test.spdx.json)
            echo "- âœ… SBOM Generated: $PACKAGE_COUNT packages" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… SPDX 2.2 validation passed" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Required packages verified" >> $GITHUB_STEP_SUMMARY
            echo "- â„¹ï¸  **Dry-run mode**: No GitHub API submission" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ SBOM generation failed" >> $GITHUB_STEP_SUMMARY
          fi
