# 機能仕様書: Worktreeとブランチ情報の一覧表示

**フィーチャーブランチ**: `002-list-worktree-branches`  
**作成日**: 2026-01-04  
**ステータス**: Draft  
**入力**: ユーザー説明: "ユーザーがworktreeに追加されているブランチを把握するためにworktreeとブランチの一覧を表示することができる。"

## 明確化事項

### セッション 2026-01-04

- Q: P3ユーザーストーリー3で、どの代替出力フォーマット（JSON、CSV等）をサポートすべきか? → A: 初期リリースでは代替フォーマットは未サポート（P3は将来機能に延期）
- Q: detached HEAD状態のworktreeをどのように表示すべきか? → A: 短縮コミットハッシュ + "(detached)" ラベルを表示（例: "abc1234 (detached)"）
- Q: worktreeリストのデフォルトソート順序は? → A: 作成日時順（新しい順）
- Q: ディスク上に存在しないworktreeをどのように扱うべきか? → A: 警告を表示してその項目をスキップし、他の有効なworktreeの表示を継続
- Q: "人間が読みやすい"出力（FR-003）には具体的にどのフォーマットを使用すべきか? → A: パス、ブランチ、ステータスの列を持つテーブル形式

## ユーザーシナリオとテスト *(必須)*

<!--
  重要: ユーザーストーリーは重要度順にPRIORITIZE（優先順位付け）すること。
  各ユーザーストーリー/ジャーニーは独立してテスト可能であること - つまり、そのうちの1つだけを実装しても、
  価値を提供する実行可能なMVP（Minimum Viable Product）を持つことができる。
  
  各ストーリーに優先度（P1、P2、P3等）を割り当て、P1が最も重要。
  各ストーリーは独立した機能スライスとして以下が可能であること:
  - 独立して開発可能
  - 独立してテスト可能
  - 独立してデプロイ可能
  - 独立してユーザーにデモ可能
-->

### ユーザーストーリー1 - すべてのworktreeとブランチを表示 (優先度: P1)

開発者は、作成されたすべてのworktreeと各worktreeでチェックアウトされているブランチの概要を確認する必要がある。これにより、worktreeを切り替えることなく、複数の作業コンテキストを管理できる。

**この優先度の理由**: これは機能のコア機能である - worktreeとブランチを表示する能力は、この機能の目的の基礎となる。

**独立テスト**: すべてのworktreeと現在のブランチを1つのビューにリストするコマンドを実行することでテスト可能。

**受入シナリオ**:

1. **前提** 開発者が異なるブランチをチェックアウトした複数のworktreeを作成している、**実行** リストコマンドを実行する、**結果** すべてのworktreeとそれに対応するブランチ名を示す構造化された出力が表示される
2. **前提** ブランチがチェックアウトされたworktreeが存在する、**実行** リストコマンドを実行する、**結果** ブランチ情報がそのworktreeに明確に関連付けられて表示される
3. **前提** worktreeが作成されていない、**実行** リストコマンドを実行する、**結果** worktreeが利用できないことを示す出力が表示される

---

### ユーザーストーリー2 - 人間が読みやすい形式でリストを表示 (優先度: P2)

開発者は、worktreeとブランチ情報が明確で読みやすい形式で表示されることを必要とする。この出力を使用して、現在の開発セットアップを一目で把握できる。

**この優先度の理由**: コマンドラインツールにとってユーザーエクスペリエンスは重要である。コア機能（P1）が動作する一方で、情報を明確に提示することで、開発者が素早く行動できるようにする。

**独立テスト**: 出力形式が人間が読みやすく、worktreeと関連するブランチが明確に分離されていることを検証することでテスト可能。

**受入シナリオ**:

1. **前提** リストコマンドに表示するデータがある、**実行** コマンドを実行する、**結果** パス、ブランチ、ステータスの列を持つテーブル形式で出力が表示される
2. **前提** 複数のworktreeが存在する、**実行** リストコマンドを実行する、**結果** 各worktreeがテーブルの別々の行として表示される

---

### ユーザーストーリー3 - 代替出力フォーマットのサポート (優先度: P3 - 将来の拡張)

開発者は、スクリプトや他のツールに適した形式でworktreeとブランチ情報をエクスポートしたい。これにより、自動化や他の開発ワークフローとの統合が可能になる。

**注意**: この機能は将来のリリースに延期される。初期リリースは人間が読みやすい出力のみに焦点を当てる。

**この優先度の理由**: 人間が読みやすい形式（P2）は典型的な対話的使用をカバーするが、代替フォーマットのサポートはパワーユーザーや自動化シナリオを可能にする。ただし、これは初期リリースにとって重要ではない。

**独立テスト**: 他のツールが解析できる代替フォーマットで出力が生成できることを検証することでテスト可能（将来のリリースで実装された場合）。

**受入シナリオ**:

1. **前提** 開発者が代替出力フォーマットフラグを指定する、**実行** リストコマンドを実行する、**結果** 指定されたフォーマットに従って出力がフォーマットされる（将来機能）
2. **前提** 出力フォーマットが指定されている、**実行** リストコマンドを実行する、**結果** すべてのworktreeとブランチ情報が代替フォーマット出力に含まれる（将来機能）

---

[必要に応じて、優先度を割り当てた追加のユーザーストーリーを追加]

### エッジケース

- worktreeは存在するがブランチがチェックアウトされていない（detached HEAD）場合はどうなるか? → 短縮コミットハッシュの後に "(detached)" ラベルを表示（例: "abc1234 (detached)"）
- ブランチ名に特殊文字やスペースが含まれている場合はどうなるか?
- ディスク上に存在しないworktreeにアクセスする場合はどうなるか? → 警告メッセージを表示してその項目をスキップし、他の有効なworktreeの表示を継続
- 非常に多数のworktreeがある場合はどうなるか（パフォーマンス/可読性）?

## 要件 *(必須)*

<!--
  アクション必要: このセクションの内容はプレースホルダーを表します。
  適切な機能要件を記入してください。
-->

### 機能要件

- **FR-001**: システムはすべてのアクティブなworktreeのリストを表示しなければならない
- **FR-002**: システムは各worktreeでチェックアウトされている現在のブランチを表示しなければならない
- **FR-003**: システムはデフォルトでパス、ブランチ、ステータスの列を持つテーブル形式で出力を表示しなければならない
- **FR-004**: システムはブランチがチェックアウトされていないworktree（detached HEAD状態）を、短縮コミットハッシュの後に "(detached)" ラベルを表示することで処理しなければならない
- **FR-005**: システムはユーザーがどのworktreeかを識別できるように、ブランチ情報と共にworktreeパスを表示しなければならない
- **FR-006**: ユーザーはこの機能をコマンドラインインターフェースを介して呼び出すことができなければならない
- **FR-007**: システムはworktreeを作成日順に新しい順でソートして表示しなければならない
- **FR-008**: システムはディスク上に存在しないworktreeに対して警告を表示し、残りのworktreeの処理を継続しなければならない

### 主要エンティティ

- **Worktree**: パス、ブランチ、状態を含むメタデータを持つGit worktreeインスタンス
- **Branch**: 名前とworktreeで現在チェックアウトされているかどうかを持つGitブランチ参照

## 成功基準 *(必須)*

<!--
  アクション必要: 測定可能な成功基準を定義してください。
  これらは技術に依存せず、測定可能でなければなりません。
-->

### 測定可能な成果

- **SC-001**: 3つ以上のworktreeでコマンドを実行する場合、ユーザーは出力を見てから5秒以内にすべてのworktreeとそのブランチを識別できる
- **SC-002**: リスト出力は人間が読みやすく、worktreeとブランチに関する情報が明確に分離されている
- **SC-003**: パスやブランチ名に特殊文字が含まれるworktreeに対して機能が正しく動作する
- **SC-004**: ユーザーは追加のヘルプドキュメントを必要とせずに、worktreeステータスを表示するワークフローを完了できる

## 前提条件

- Gitリポジトリはすでに初期化されており、標準のGit worktreeコマンドを使用してworktreeが作成されている
- システムはGitにアクセスでき、git worktree listおよび関連コマンドを実行できる
- デフォルトの出力形式は完全性よりも人間の可読性を優先すべきである（追加のフォーマットは将来の反復で追加可能）
