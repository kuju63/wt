# Feature Specification: Git Worktree 作成コマンド

**Feature Branch**: `001-create-worktree`  
**Created**: 2026-01-03  
**Status**: Draft  
**Input**: User description: "ユーザーはコマンドを実行することで新規にブランチ作成するとともにgit worktree への追加を行うことができる。追加後は必要に応じてVSCodeをや任意のエディターを起動できるようにする。ブランチはユーザーからの入力を元にして作成する。ブランチ作成時にgit worktreeへ自動的に追加することで、AIコードエージェントを並列で実行できたり、AIコードエージェントの作業と平行して手作業による開発を行うようにする。特にgit worktreeへの登録はコマンドが複雑であり、これを簡略化することで開発者は本来注力するべき、仕様や実装にリソースを割くことができるようになる。"

## Clarifications

### Session 2026-01-03

- Q: 新しいブランチを作成する際のベースブランチの決定方法は？ → A: 現在のブランチをベースとし、オプションで指定可能
- Q: デフォルト worktree パスの命名規則は？ → A: `../worktrees/<branch-name>` - 複数worktreeを1ディレクトリに集約
- Q: VS Code 以外のエディター対応範囲は？ → A: 一般的なエディター（VS Code、vim、emacs、nano、IntelliJ IDEA）のプリセットを提供
- Q: エラーメッセージの詳細度は？ → A: 基本エラー + 解決策の提示 + verbose モードで詳細
- Q: ブランチ名が既に存在する場合の動作は？ → A: エラーで停止 + 既存ブランチをチェックアウトするオプション提示

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Git Worktree 作成の基本機能 (Priority: P1)

開発者が新しいブランチ名を指定してコマンドを実行すると、ブランチが作成され、自動的に git worktree として登録される。これにより、開発者は複雑な git worktree コマンドを覚える必要がなく、すぐに並列開発を開始できる。

**Why this priority**: この機能の中核であり、これがなければ他の機能も成立しない。git worktree の複雑なコマンドを抽象化することが最大の価値提供。

**Independent Test**: ブランチ名を指定してコマンドを実行し、worktree が作成されることを確認すれば、この機能は独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 既存のGitリポジトリがある、**When** ユーザーが新しいブランチ名を指定してコマンドを実行する、**Then** 指定したブランチが作成され、worktree ディレクトリが生成される
2. **Given** worktree が作成された、**When** worktree ディレクトリに移動する、**Then** 指定したブランチにチェックアウトされている
3. **Given** ユーザーが既存のブランチ名を指定する、**When** コマンドを実行する、**Then** エラーメッセージが表示され、worktree は作成されない

---

### User Story 2 - エディター自動起動機能 (Priority: P2)

worktree 作成後、開発者がオプションで指定したエディター（VS Code など）を自動起動できる。これにより、worktree 作成からコーディング開始までの手順が1コマンドで完結する。

**Why this priority**: 開発者体験を大幅に向上させるが、P1 の基本機能がなければ意味がない。付加価値として位置づけられる。

**Independent Test**: worktree 作成時にエディター起動オプションを指定し、エディターが自動的に開くことを確認すれば、この機能は独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** VS Code がインストールされている、**When** ユーザーが VS Code オプション付きでコマンドを実行する、**Then** worktree が作成され、VS Code が worktree ディレクトリで起動する
2. **Given** エディターが指定されていない、**When** コマンドを実行する、**Then** worktree のみが作成され、エディターは起動しない
3. **Given** 指定されたエディターが見つからない、**When** コマンドを実行する、**Then** 警告メッセージが表示されるが、worktree は正常に作成される

---

### User Story 3 - Worktree パスのカスタマイズ (Priority: P3)

開発者が worktree を作成する場所（パス）をカスタマイズできる。デフォルトでは親ディレクトリに作成されるが、特定のプロジェクト構造やディスク容量の制約がある場合に柔軟に対応できる。

**Why this priority**: 一部の開発者には必要だが、デフォルト動作で大半のユースケースをカバーできる。

**Independent Test**: カスタムパスを指定してコマンドを実行し、指定した場所に worktree が作成されることを確認すれば、この機能は独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** カスタムパスを指定する、**When** コマンドを実行する、**Then** 指定したパスに worktree が作成される
2. **Given** 無効なパス（書き込み権限がない等）を指定する、**When** コマンドを実行する、**Then** エラーメッセージが表示され、worktree は作成されない
3. **Given** パスが指定されていない、**When** コマンドを実行する、**Then** デフォルトパス（親ディレクトリ）に worktree が作成される

---

### Edge Cases

- **既存のブランチ名を指定した場合**: エラーで停止し、既存ブランチをチェックアウトして worktree を作成するオプション（例：`--checkout-existing`）を提示する
- **既存の worktree と同じ名前を指定した場合**: エラーメッセージを表示し、既存の worktree 一覧を提示する
- **Git リポジトリではないディレクトリでコマンドを実行した場合**: 明確なエラーメッセージと解決策を表示する
- **ブランチ名に不正な文字が含まれている場合**: Git の命名規則に基づいてバリデーションを行い、エラーメッセージと有効な文字の例を表示する
- **ディスク容量が不足している場合**: 作成前にスペースをチェックし、警告を表示する
- **ネットワーク共有ディレクトリで実行した場合**: パフォーマンス警告を表示するが、処理は継続する
- **指定されたエディターが見つからない場合**: 警告メッセージを表示するが、worktree は正常に作成される（verbose モードで詳細な診断情報を提供）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは CLI コマンドとして動作し、ブランチ名を引数として受け取る必要がある
- **FR-002**: システムは指定されたブランチ名でGitブランチを作成する必要がある。デフォルトでは現在のブランチをベースとし、オプションでベースブランチを指定可能にする
- **FR-003**: システムは作成したブランチを git worktree として自動的に登録する必要がある
- **FR-004**: システムは worktree の作成場所をデフォルト（`../worktrees/<branch-name>`）として、オプションでカスタマイズ可能にする必要がある
- **FR-005**: システムはオプションでエディター（VS Code、vim、emacs、nano、IntelliJ IDEA）を自動起動できる必要がある。これらの一般的なエディターのプリセットを提供する
- **FR-006**: システムは既存のブランチ名や worktree 名の重複を検出し、エラーで停止する必要がある。その際、既存ブランチをチェックアウトして worktree を作成するオプション（例：`--checkout-existing`）を提示する
- **FR-007**: システムは Git リポジトリの存在を確認し、非 Git ディレクトリでは実行できないようにする必要がある
- **FR-008**: システムはブランチ名のバリデーションを行い、Git の命名規則に従わない名前を拒否する必要がある
- **FR-009**: システムは処理の進行状況を明確に表示する必要がある（ブランチ作成中、worktree 作成中など）
- **FR-010**: システムはエラー発生時に基本エラーメッセージと具体的な解決策を表示する必要がある。verbose モードで詳細なスタックトレースと診断情報を提供する
- **FR-011**: システムは人間が読める形式と JSON 形式の両方で出力をサポートする必要がある

### Key Entities

- **Branch**: Git ブランチを表現する。名前、ベースブランチ（デフォルトは現在のブランチ、オプションで指定可能）の情報を持つ
- **Worktree**: Git worktree を表現する。パス（デフォルト: `../worktrees/<branch-name>`）、関連するブランチ、作成日時の情報を持つ
- **EditorConfig**: エディター設定を表現する。エディター種類（VS Code、vim、emacs、nano、IntelliJ IDEA のプリセット）、起動コマンド、パスの情報を持つ

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 開発者が worktree 作成コマンドを実行してから作業を開始するまでの時間が 30 秒以内である
- **SC-002**: 開発者が git worktree の複雑なコマンド構文を覚える必要がなく、1つの明瞭なコマンドで操作できる
- **SC-003**: コマンド実行の 95% 以上が初回で成功する（明確なエラーメッセージによりユーザーが問題を即座に修正できる）
- **SC-004**: Windows、macOS、Linux の主要 OS で同じコマンド構文が動作する
- **SC-005**: エディター自動起動機能により、worktree 作成から開発開始までの手作業が 1 コマンドに削減される

## Assumptions

1. **Git のバージョン**: Git 2.5 以上がインストールされていることを前提とする（git worktree サポート開始バージョン）
2. **デフォルト worktree パス**: `../worktrees/<branch-name>` をデフォルトとし、複数の worktree を1ディレクトリに集約する
3. **ベースブランチ**: 新しいブランチは現在のブランチをベースとして作成され、オプションで異なるベースブランチを指定可能
4. **エディター検出**: 一般的なエディター（VS Code、vim、emacs、nano、IntelliJ IDEA）は標準的なインストールパスで検出可能と仮定する
5. **ブランチ名規則**: Git の標準的な命名規則（英数字、ハイフン、アンダースコア）に従う
6. **権限**: ユーザーは worktree 作成先ディレクトリ（デフォルトは `../worktrees/`）への書き込み権限を持つと仮定する
7. **既存ブランチ**: 既存のブランチ名を指定した場合はエラーで停止し、既存ブランチをチェックアウトするオプションを提示する

## Out of Scope

1. **既存 worktree の管理機能**: 既存 worktree の削除、リスト表示、切り替えは本機能の範囲外（将来的な拡張として検討可能）
2. **リモートブランチの自動プッシュ**: 作成したブランチをリモートリポジトリに自動的にプッシュする機能は含まない
3. **Worktree 間の変更のマージ**: 複数 worktree 間での変更のマージやコンフリクト解決支援は含まない
4. **IDE の高度な設定**: エディター起動は単純な起動のみで、IDE のプロジェクト設定やワークスペース設定は行わない
