# 機能仕様書: リリースパイプラインにおける完全なSBOM生成

**機能ブランチ**: `004-complete-sbom-generation`  
**作成日**: 2026-01-06  
**ステータス**: ドラフト  
**入力**: ユーザー記述: "SBOMの生成時にプロジェクトのリストアを行っていないため、完全なSBOMが生成されない。現在のリリースパイプラインを変更して、完全な依存関係を含むSBOMを生成できるようにする。これにより、生成物のサプライチェーンの透明性を担保し、ユーザーが生成物の信頼性をチェックできるようにする。"

## Clarifications

### Session 2026-01-06

- Q: GitHub Dependency Submission APIへの送信が失敗した場合、パイプライン全体を失敗させるべきか？ → A: パイプラインを失敗させる - API送信は必須、失敗時は全体を停止
- Q: SBOM形式はSPDXとCycloneDXのどちらを優先すべきか？ → A: SPDX 2.3+ - Microsoftツールとの互換性、ISO標準
- Q: 大規模ソリューションでのSBOM生成のタイムアウト値はどうすべきか？ → A: 15分タイムアウト - 大規模対応、キャッシング推奨
- Q: 条件付き依存関係（プラットフォーム固有または構成固有）の処理方法は？ → A: すべて含む - 全プラットフォーム/構成の依存関係を含む
- Q: ライセンス情報が利用できない依存関係の処理方法は？ → A: NOASSERTIONマーク - SPDX標準に従い警告記録

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー1 - 完全な依存関係の開示 (優先度: P1)

セキュリティ監査者またはエンドユーザーとして、使用または評価しているソフトウェアのサプライチェーンの整合性を検証し、潜在的なセキュリティ脆弱性を特定できるように、すべてのプロジェクト依存関係を含む完全なソフトウェア部品表（SBOM: Software Bill of Materials）を確認する必要がある。

**この優先度の理由**: これは中心的な要件です。SBOMに完全な依存関係情報がなければ、ユーザーは正確なセキュリティ評価やコンプライアンスチェックを実行できず、SBOM生成の主要な目的が損なわれます。

**独立テスト**: リリースパイプラインからSBOMを生成し、プロジェクトファイルに記載されている実際のプロジェクト依存関係と比較し、すべての依存関係（直接的および推移的）が生成されたSBOMに含まれていることを検証することで完全にテストできます。

**受入シナリオ**:

1. **前提条件** ビルドのためにリリースパイプラインがトリガーされる、**操作** SBOM生成ステップが実行される、**期待結果** 生成されたSBOMにプロジェクトファイルで宣言されたすべての直接依存関係が含まれている
2. **前提条件** 推移的依存関係を持つプロジェクト、**操作** SBOMが生成される、**期待結果** SBOMに完全な依存関係チェーンを持つすべての推移的依存関係が含まれている
3. **前提条件** マルチプロジェクトソリューション、**操作** SBOMが生成される、**期待結果** SBOMにソリューション内のすべてのプロジェクトからの依存関係が含まれている
4. **前提条件** プラットフォーム固有の依存関係を持つプロジェクト、**操作** SBOMが生成される、**期待結果** SBOMにすべてのターゲットプラットフォームの依存関係が含まれている

---

### ユーザーストーリー2 - SBOMの検証 (優先度: P2)

DevOpsエンジニアとして、リリース成果物を公開する前に生成されたSBOMが完全かつ正確であることを検証し、ユーザーに信頼できるサプライチェーン情報を提供できるようにする必要がある。

**この優先度の理由**: 検証は重要ですが、生成の次に来るものです。ユーザーはまず完全なSBOMを必要とし、検証は段階的に追加できます。

**独立テスト**: SBOMの内容を復元されたプロジェクト依存関係と比較し、不一致を報告する検証ステップを実装することでテストできます。

**受入シナリオ**:

1. **前提条件** SBOMが生成されている、**操作** 検証ステップが実行される、**期待結果** すべての依存関係が含まれている場合は成功、依存関係が不足している場合は失敗を報告する
2. **前提条件** 検証が失敗した場合、**操作** パイプラインログを確認する、**期待結果** 不足または不完全な依存関係が明確にリストされている
3. **前提条件** 検証が成功した場合、**操作** リリース成果物が公開される、**期待結果** SBOMがリリースパッケージに含まれている

---

### ユーザーストーリー3 - SBOM形式の準拠 (優先度: P3)

コンプライアンス担当者として、生成されたSBOMが業界標準形式（SPDXやCycloneDXなど）に従っていることで、標準的なツールを使用してSBOMを分析し、セキュリティインフラストラクチャに統合できるようにする必要がある。

**この優先度の理由**: 形式の準拠はツールの相互運用性にとって重要ですが、完全性を確保することよりも重要度は低いです。ほとんどのSBOM生成ツールはすでに標準形式をサポートしています。

**独立テスト**: 生成されたSBOMを公式のSPDXまたはCycloneDXスキーマバリデーターで検証することでテストできます。

**受入シナリオ**:

1. **前提条件** SBOMが生成される、**操作** SPDX 2.3+スキーマに対して検証される、**期待結果** エラーなしで検証に合格する
2. **前提条件** SPDX形式のSBOM、**操作** 一般的なSBOM分析ツールに読み込む、**期待結果** ツールがエラーなしで解析および分析できる

---

### ユーザーストーリー4 - GitHubへのSBOM統合 (優先度: P2)

開発者またはセキュリティ担当者として、生成されたSBOMがGitHubの依存関係グラフに自動的に統合され、DependabotアラートやGitHubのセキュリティ機能を活用できるようにする必要がある。

**この優先度の理由**: GitHubエコシステムとの統合により、セキュリティ脆弱性の自動検出とアラートが可能になり、長期的な保守性が向上します。P2とするのは、基本的なSBOM生成（P1）の後に実装すべき重要な機能だからです。

**独立テスト**: パイプラインがGitHubのDependency Submission APIにSBOMを送信し、GitHubの依存関係グラフでSBOM情報が表示されることを確認することでテストできます。

**受入シナリオ**:

1. **前提条件** SBOMが生成された後、**操作** Dependency Submission APIにSBOMを送信する、**期待結果** GitHubの依存関係グラフにすべての依存関係が表示される
2. **前提条件** 脆弱性のある依存関係が含まれている、**操作** SBOMをGitHubに送信する、**期待結果** Dependabotアラートが自動的に生成される
3. **前提条件** リリースが公開される、**操作** SBOMファイルがリリース成果物として添付される、**期待結果** ユーザーがリリースページからSBOMファイルをダウンロードできる
4. **前提条件** RenovateがリポジトリにインストールされSBOMが送信されている、**操作** 依存関係の新しいバージョンがリリースされる、**期待結果** Renovateが依存関係グラフの情報を読み取り、バージョンアップのPRを自動作成する

---

### エッジケース

- SBOM生成ステップ中にプロジェクトの復元が失敗した場合はどうなるか？
  - 回答: パイプラインは失敗し、リリースは中止される（FR-004）
- システムは条件付き依存関係（プラットフォーム固有または構成固有）をどのように処理するか？
  - 回答: すべてのターゲットプラットフォームおよびビルド構成に対する依存関係を含む（FR-016）
- 復元中に依存関係が解決またはダウンロードできない場合はどうなるか？
  - 回答: パイプラインは失敗し、エラーログに詳細を記録（FR-007）
- パイプラインは、タイムアウトせずに多数のプロジェクトと依存関係を持つ大規模なソリューションをどのように処理するか？
  - 回答: 15分のタイムアウトを設定し、超過した場合は失敗。依存関係キャッシングの使用を推奨（FR-014、FR-015）
- プロジェクトに循環依存関係の参照が存在する場合はどうなるか？
  - 回答: パッケージマネージャーのエラー処理に従い、パイプラインは失敗
- GitHub Dependency Submission APIへの送信が失敗した場合、パイプライン全体を失敗させるべきか？
  - 回答: パイプラインを失敗させる - API送信は必須機能であり、失敗時は全体を停止（FR-011、FR-013）
- リリース成果物へのSBOMファイルの添付が失敗した場合はどうなるか？
  - 回答: パイプラインは失敗し、リリースは中止される（FR-005、FR-012）
- プライベートリポジトリとパブリックリポジトリで、依存関係グラフの動作に違いはあるか？
  - 回答: はい、プライベートリポジトリでは依存関係グラフを手動で有効化する必要がある場合がある（仮定に記載）

## 要件 *(必須)*

### 機能要件

- **FR-001**: リリースパイプラインは、SBOMを生成する前にプロジェクトの依存関係を復元しなければならない
- **FR-002**: SBOM生成は、プロジェクトファイルで宣言されたすべての直接依存関係を含まなければならない
- **FR-003**: SBOM生成は、復元中に解決されたすべての推移的依存関係を含まなければならない
- **FR-004**: リリースパイプラインは、SBOM生成が失敗した場合、完全なサプライチェーン情報のない成果物のリリースを防ぐために失敗しなければならない
- **FR-005**: 生成されたSBOMは、個別のファイルとしてリリース成果物に含まれなければならない
- **FR-006**: SBOMは、SPDX 2.3+形式に従わなければならない（ISO/IEC 5962:2021準拠）
- **FR-007**: パイプラインは、トラブルシューティングのために復元とSBOM生成プロセスの詳細をログに記録しなければならない
- **FR-008**: SBOM生成は、マルチプロジェクトソリューションを正しく処理しなければならない
- **FR-009**: SBOMは、各依存関係のバージョン情報を含まなければならない
- **FR-010**: SBOMは、各依存関係のライセンス情報を含まなければならない（利用できない場合は"NOASSERTION"）
- **FR-011**: 生成されたSBOMは、GitHubのDependency Submission APIを使用してGitHubの依存関係グラフに送信しなければならない
- **FR-012**: SBOMファイルは、GitHubリリースの成果物として添付しなければならない（ユーザーがダウンロード可能）
- **FR-013**: GitHub Dependency Submission APIへの送信が失敗した場合、リリースパイプラインは失敗しなければならない
- **FR-014**: SBOM生成プロセス（依存関係の復元と生成）は、15分以内に完了しなければならず、超過した場合はタイムアウトエラーとしてパイプラインを失敗させる
- **FR-015**: パイプラインは、依存関係キャッシングを使用して、繰り返しビルドでの復元時間を短縮することが推奨される
- **FR-016**: SBOM生成は、すべてのターゲットプラットフォームおよびビルド構成に対する条件付き依存関係を含まなければならない（完全な透明性のため）
- **FR-017**: ライセンス情報が利用できない依存関係については、SPDX標準に従い"NOASSERTION"値を使用し、警告をログに記録しなければならない
- **FR-018**: GitHubの依存関係グラフに送信されたSBOM情報は、RenovateなどのOSS依存関係管理ツールから読み取り可能でなければならない
- **FR-019**: Pull Request作成時にSBOM生成を自動テストする専用ワークフローを提供しなければならない（リリース前の不具合検出のため）
- **FR-020**: PR時のSBOMテストは、SPDXフォーマット検証、必須パッケージの存在確認、パフォーマンスベンチマークを含まなければならない
- **FR-021**: PR時のSBOMテストワークフローは、GitHub Dependency Submission APIを呼び出してはならない（Dry-runモードのみ、本番依存関係グラフを汚染しないため）

### 主要なエンティティ

- **リリースパイプライン**: ソフトウェアリリースをビルド、テスト、公開する自動化されたワークフロー。依存関係の復元とSBOM生成のステップを含む
- **SBOM（ソフトウェア部品表）**: すべてのソフトウェアコンポーネント、依存関係、および関連するメタデータ（バージョン、ライセンスなど）をリストする構造化されたドキュメント
- **プロジェクト依存関係**: プロジェクトファイル（例: .csproj、package.json）で明示的に宣言された直接依存関係
- **推移的依存関係**: 直接依存関係によって必要とされる間接的な依存関係
- **リリース成果物**: リリースパイプラインの最終出力。コンパイルされたバイナリ、ドキュメント、およびSBOMを含む
- **GitHubの依存関係グラフ**: GitHubが提供する依存関係の可視化機能。SBOM情報を統合し、セキュリティアラートと連携する
- **Dependency Submission API**: GitHubにSBOMや依存関係情報を送信するためのREST API。依存関係グラフに統合され、Dependabotアラートとセキュリティ更新を有効にする
- **Renovate**: OSSで広く利用される依存関係管理ツール。GitHubの依存関係グラフを読み取り、ライブラリのバージョンアップに対して一貫した自動PR作成を提供する

### 仮定

- プロジェクトは、依存関係の復元をサポートする標準的なパッケージ管理システムを使用している
- Microsoft SBOM Toolまたは同等のSPDX 2.3+互換ツールがプロジェクトタイプと互換性があり、利用可能であるか、統合可能である
- リリースパイプラインは、復元中に依存関係をダウンロードするためのネットワークアクセスを持っている
- SPDX 2.3+形式は、ユースケースおよびコンプライアンス要件に対して受け入れ可能である
- ライセンス情報はパッケージメタデータで利用可能であるか、合理的に推測できる
- パイプラインインフラストラクチャは、すべての依存関係を復元するための十分なリソース（ディスク容量、メモリ、時間）を持っている
- リポジトリはGitHub上でホストされており、GitHub ActionsまたはGitHub APIへのアクセスが可能である
- 適切なGitHubトークン権限（contents: write）がDependency Submission APIの使用に利用可能である
- GitHubの依存関係グラフ機能が、リポジトリで有効化されている（プライベートリポジトリの場合、手動で有効化が必要な場合がある）
- 送信されたSBOM情報は、Dependency Submission API経由でGitHubの依存関係グラフに統合され、DependabotおよびRenovateの両方から利用可能である

### 依存関係

- 既存のリリースパイプラインインフラストラクチャは、新しいビルドステップの追加をサポートしなければならない
- パッケージソース（NuGet、npmなど）は、パイプライン実行中にアクセス可能でなければならない
- SBOM生成ツールは、プロジェクトの技術スタックと互換性がなければならない
- GitHub Dependency Submission APIは、パイプラインから利用可能でなければならない
- GitHubリリース機能は、成果物のアップロードをサポートしていなければならない

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 生成されたSBOMには、プロジェクト依存関係の100%が含まれている（プロジェクトファイルとロックファイルの内容との比較により検証）
- **SC-002**: SBOM生成ステップは、一般的なプロジェクトサイズ（最大50の依存関係を持つソリューション）に対して5分以内に完了する
- **SC-003**: 大規模ソリューション（最大200の依存関係）でも15分以内にSBOM生成が完了する
- **SC-004**: リリースパイプラインは、手動介入なしで95%のビルドでSBOMを正常に生成および公開する
- **SC-005**: ユーザーは、標準的なSBOM検証ツールを使用して、エラーなしで生成されたSBOMを正常に検証できる
- **SC-006**: 実装後、完全なSBOMなしで公開されるリリースはゼロである
- **SC-007**: GitHubの依存関係グラフには、SBOMから送信されたすべての依存関係が表示される
- **SC-008**: 脆弱性のある依存関係に対して、GitHubが自動的にDependabotアラートを生成する
- **SC-009**: ユーザーは、GitHubリリースページからSBOMファイルをダウンロードできる
- **SC-010**: Renovateがインストールされている場合、SBOM情報を読み取り、依存関係の更新PRを自動作成できる
- **SC-011**: Pull Request作成時にSBOM生成テストが自動実行され、リリース前に不具合を検出できる
- **SC-012**: PR時のSBOMテストは10分以内に完了し、開発サイクルを妨げない
