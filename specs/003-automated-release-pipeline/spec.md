# 機能仕様書: 自動化されたバイナリリリースパイプライン

**機能ブランチ**: `001-automated-release-pipeline`  
**作成日**: 2026-01-04  
**ステータス**: ドラフト  
**Input**: User description: "ユーザーはコンパイル済みのバイナリをGitHub Releaseからダウンロードしてインストールする。このバイナリファイルはテスト済みであり、別途ファイルハッシュやCycloneDXによる依存関係が取得できなければならない。バイナリファイルはWindows、Linux（Redhat系, Debian系）、Macをサポートし、Windowsはx64のみ、Linuxはx64とARM系、Macはaarm64を対象とする。このバイナリのリリースには人手を介してはならず（セキュリティの担保のため）、すべてGitHub Hostedな環境で完結すること。バイナリのリリースタイミングはmainへのマージタイミングとし、一貫したバージョン管理によりユーザーへの変更を保証するものとする。これらの前提としてすべてのブランチは都度テストされる必要があり、カバレッジはCodacyに集約されている必要がある。Codacyには本プロジェクトの品質情報が集約されているため、カバレッジもその指標として扱われる。"

## ユーザーシナリオとテスト *(必須)*

<!--
  重要: ユーザーストーリーは重要度順に優先順位付けする必要があります。
  各ユーザーストーリー/ジャーニーは独立してテスト可能でなければなりません。
  つまり、そのうちの1つだけを実装しても、価値を提供できる実用最小限の製品（MVP）である必要があります。
  
  各ストーリーに優先度（P1、P2、P3など）を割り当て、P1が最も重要です。
  各ストーリーを、以下のように独立した機能スライスとして考えてください:
  - 独立して開発可能
  - 独立してテスト可能
  - 独立してデプロイ可能
  - ユーザーに独立してデモンストレーション可能
-->

### ユーザーストーリー 1 - コンパイル済みバイナリのダウンロードとインストール (優先度: P1)

エンドユーザーとして、ソースからビルドすることなく、GitHub Releasesから事前コンパイルされテスト済みのバイナリをダウンロードしてシステムにインストールし、アプリケーションをすぐに使い始めたい。

**この優先度の理由**: これは中核的な価値提案です - ユーザーにすぐに使えるバイナリを提供すること。これがなければ、ユーザーはアプリケーションに簡単にアクセスできません。

**独立テスト**: サポートされている任意のプラットフォーム向けリリースバイナリをダウンロードし、ファイルハッシュを検証し、バイナリを実行して正しく動作することを確認することで完全にテストできます。動作するアプリケーションを提供することで即座に価値を提供します。

**受け入れシナリオ**:

1. **前提条件** GitHub Releasesページにいる、**操作** 最新リリースを選択する、**期待結果** サポートされているすべてのプラットフォーム（Windows x64、Linux x64、Linux ARM、Mac ARM64）のダウンロードリンクが表示される
2. **前提条件** 自分のプラットフォーム向けのバイナリをダウンロードした、**操作** 提供されたハッシュファイルに対してファイルハッシュを検証する、**期待結果** ハッシュが完全に一致する
3. **前提条件** バイナリをダウンロードした、**操作** インストールして実行する、**期待結果** アプリケーションが正常に実行されバージョン情報が表示される
4. **前提条件** Windows x64ユーザーである、**操作** Windowsバイナリをダウンロードする、**期待結果** Windows x64で動作する.exeファイルを受け取る
5. **前提条件** Linuxユーザー（RedhatまたはDebian）である、**操作** Linuxバイナリをダウンロードする、**期待結果** x64とARMアーキテクチャの両方で動作するバイナリを受け取る
6. **前提条件** Mac ARM64ユーザーである、**操作** Macバイナリをダウンロードする、**期待結果** ARM64アーキテクチャでネイティブに動作するバイナリを受け取る

---

### ユーザーストーリー 2 - ソフトウェアサプライチェーンセキュリティの検証 (優先度: P1)

セキュリティ意識の高いユーザーとして、CycloneDX SBOMとファイルハッシュを通じてバイナリの依存関係と完全性を検証し、ソフトウェアが信頼でき改ざんされていないことを確認したい。

**この優先度の理由**: セキュリティは企業やセキュリティ意識の高いユーザーにとって重要です。これにより信頼が構築され、セキュリティポリシーへの準拠が可能になります。

**独立テスト**: リリースをダウンロードし、SBOMの可用性を確認し、すべてのチェックサムを検証し、依存関係情報が完全であることを確認することで完全にテストできます。バイナリの機能とは独立してセキュリティの透明性を提供します。

**受け入れシナリオ**:

1. **前提条件** 新しいリリースが公開された、**操作** リリースアセットにアクセスする、**期待結果** すべての依存関係を一覧表示するCycloneDX SBOMファイル（JSONまたはXML形式）が見つかる
2. **前提条件** SBOMファイルを持っている、**操作** それを解析する、**期待結果** パッケージ名、バージョン、ライセンスを含む完全な依存関係情報が表示される
3. **前提条件** 新しいリリースが公開された、**操作** リリースアセットにアクセスする、**期待結果** すべてのバイナリのハッシュを含むチェックサムファイル（例: SHA256SUMS）が見つかる
4. **前提条件** バイナリとチェックサムファイルをダウンロードした、**操作** ローカルでハッシュを計算する、**期待結果** チェックサムファイル内のハッシュと一致する
5. **前提条件** ソフトウェアサプライチェーンを監査する必要がある、**操作** SBOMをレビューする、**期待結果** すべてのサードパーティ依存関係とそのセキュリティステータスを特定できる

---

### ユーザーストーリー 3 - mainブランチマージ時の自動リリース受信 (優先度: P2)

ユーザーとして、変更がmainブランチにマージされたときに新しいリリースが自動的に公開され、一貫したバージョン管理により常に最新の安定版にアクセスできるようにしたい。

**この優先度の理由**: 自動化により適時の更新が保証され、手動エラーが削減されます。一貫したバージョン管理により、ユーザーは変更を追跡し更新を計画できます。

**独立テスト**: mainへの変更をマージし、新しいリリースが自動的に作成されることを確認し、バージョン番号が正しくインクリメントされることを確認し、新しいリリースをダウンロードすることで完全にテストできます。継続的デリバリーの価値を独立して提供します。

**受け入れシナリオ**:

1. **前提条件** プルリクエストがmainにマージされた、**操作** マージが完了する、**期待結果** 手動介入なしで新しいGitHub Releaseが自動的に作成される
2. **前提条件** 新しいリリースがトリガーされた、**操作** リリースを確認する、**期待結果** セマンティックバージョニングに従ったバージョン番号（例: v1.2.3）がある
3. **前提条件** mainへの複数のマージが発生した、**操作** リリースを比較する、**期待結果** バージョン番号が一貫してインクリメントされる（変更タイプに基づいてpatch、minor、またはmajor）
4. **前提条件** リリースが作成された、**操作** リリースノートをレビューする、**期待結果** 前回のリリース以降に含まれる変更の要約が表示される
5. **前提条件** リリースを監視している、**操作** 新しいバージョンが公開される、**期待結果** 通知を購読して情報を得られる

---

### ユーザーストーリー 4 - カバレッジ付きですべての変更がテストされることの検証 (優先度: P2)

プロジェクトメンテナーとして、リリース前にすべてのブランチがカバレッジレポート付きで自動的にテストされCodacyに報告されることで、品質基準が維持されることを確認したい。

**この優先度の理由**: 品質保証は、リリースされたバイナリへの信頼を維持するために不可欠です。自動テストにより回帰を防ぎます。

**独立テスト**: ブランチを作成し、変更をプッシュし、テストが自動的に実行されることを確認し、カバレッジがCodacyに報告されることを確認し、失敗したテストがリリースをブロックすることを確認することで完全にテストできます。品質保証を独立して提供します。

**受け入れシナリオ**:

1. **前提条件** 任意のブランチに変更をプッシュした、**操作** プッシュが完了する、**期待結果** すべてのテストが自動的に実行される
2. **前提条件** テストが完了した、**操作** Codacyを確認する、**期待結果** カバレッジレポートが最新のデータで更新される
3. **前提条件** ブランチでテストが失敗した、**操作** mainへのマージを試みる、**期待結果** テストが合格するまでマージがブロックされる
4. **前提条件** カバレッジが閾値を下回った、**操作** プルリクエストをレビューする、**期待結果** カバレッジの低下を示す警告が表示される
5. **前提条件** すべてのテストが合格しカバレッジが適切である、**操作** mainへのマージが発生する、**期待結果** リリースプロセスが自動的にトリガーされる

---

### エッジケース

- リリースプロセス中にビルドが失敗した場合どうなるか？（システムは不完全または失敗したビルドでリリースを作成してはならない）
- システムはプラットフォーム固有のビルド失敗をどのように処理するか？（必須プラットフォームのいずれかが失敗した場合はリリース全体を失敗させる。オプショナルプラットフォームの失敗は警告を生成するがリリースをブロックしない）
- カバレッジレポート中にCodacyが利用できない場合どうなるか?(システムは再試行するか、ビルドをブロックせずに明確なエラーメッセージを提供すべき。カバレッジ報告の失敗のみではリリースをブロックしない)
- 複数のマージが同時に発生した場合、バージョン競合はどのように解決されるか？（システムはマージ順序に基づいて順次バージョン管理を使用すべき）
- バイナリ署名やチェックサムが生成できない場合どうなるか？（システムはセキュリティ保証を維持するためにリリースを失敗させるべき）
- システムはGitHubリリースのサイズ制限を超える非常に大きなバイナリをどのように処理するか？（システムは必要に応じてバイナリを圧縮するか複数のアセットに分割すべき）
- ユーザーが間違ったプラットフォーム向けのバイナリをダウンロードした場合どうなるか？（システムはファイル名に明確な命名規則とプラットフォームインジケータを提供すべき。形式: `<プロジェクト名>-<バージョン>-<プラットフォーム>-<アーキテクチャ>`）
- バージョン番号で破壊的変更はどのように伝えられるか？（システムはメジャーバージョンのインクリメントで破壊的変更を示すセマンティックバージョニングに従うべき）

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは変更がmainブランチにマージされたときに自動的にリリース作成をトリガーしなければならない
- **FR-002**: システムはサポートされているプラットフォーム向けのバイナリをビルドしなければならない。必須プラットフォーム: Windows (x64)、Linux x64 (Redhat系/Debian系)、Mac (ARM64)。オプショナルプラットフォーム: Linux ARM (Redhat系/Debian系)。必須プラットフォームのビルド失敗はリリースをブロックする
- **FR-003**: システムはすべてのバイナリアーティファクトのファイルハッシュ（SHA256）を生成しなければならない
- **FR-004**: システムは各バイナリのすべての依存関係を含むCycloneDX SBOM（ソフトウェア部品表）を生成しなければならない
- **FR-005**: システムはmainへのマージを許可する前に、すべてのブランチのすべてのテストを実行しなければならない
- **FR-006**: システムはすべてのブランチのテストカバレッジをCodacyに報告しなければならない。カバレッジ目標は80%とし、これを下回る場合は警告を表示する
- **FR-007**: システムはソースブランチでテストが失敗した場合、mainへのマージをブロックしなければならない。カバレッジ低下のみではマージをブロックしない
- **FR-008**: システムはGitHubホステッドランナーのみを使用しなければならない（セルフホステッドランナーは使用不可）
- **FR-009**: システムはすべてのビルド、テスト、リリース操作を手動介入なしで実行しなければならない
- **FR-010**: システムはすべてのリリースに一貫したセマンティックバージョニングを適用しなければならない。バージョンインクリメントはConventional Commits規約（feat:でminor、fix:でpatch、BREAKING CHANGE:でmajor）に基づいて自動的に決定される
- **FR-011**: システムはバイナリ、ハッシュファイル、SBOMファイルをGitHub Releaseアセットとして利用可能にしなければならない。バイナリ命名規則: `<プロジェクト名>-<バージョン>-<プラットフォーム>-<アーキテクチャ>`（例: wt-v1.2.3-windows-x64.exe, wt-v1.2.3-linux-x64, wt-v1.2.3-linux-arm64, wt-v1.2.3-darwin-arm64）
- **FR-011a**: システムはSBOMファイル（JSON）とSHA256SUMSファイルに対してデジタル署名を生成しなければならない。署名ファイル（.sig形式）もGitHub Releaseアセットとして公開される。注：バイナリ自体の署名は技術的制約により除外
- **FR-012**: システムはリリースに含まれる前にバイナリがテストされていることを保証しなければならない
- **FR-013**: システムは前回のリリース以降の変更を要約したリリースノートを含めなければならない。リリースノートはConventional Commitsから自動生成され、機能追加(feat:)、バグ修正(fix:)、破壊的変更(BREAKING CHANGE:)等のカテゴリ別に整理される
- **FR-014**: システムは障害を適切に処理し、ワークフローログに明確なエラーメッセージを提供しなければならない
- **FR-015**: システムはすべてのリリースアーティファクトがGitHub Releasesから公開ダウンロード可能であることを保証しなければならない

### 主要エンティティ

- **バイナリアーティファクト**: 特定のプラットフォーム（Windows x64、Linux x64、Linux ARM、Mac ARM64）向けのコンパイル済み実行可能ファイルで、テスト済みで配布準備完了
- **ファイルハッシュ**: 各バイナリアーティファクトのSHA256チェックサムで、完全性の検証と改ざんの検出に使用
- **SBOM（ソフトウェア部品表）**: バイナリに含まれるすべての依存関係、バージョン、ライセンスを一覧表示するCycloneDX形式のドキュメント
- **リリース**: バイナリアーティファクト、ハッシュファイル、SBOMファイル、リリースノートのバージョン管理されたコレクションで、GitHub Releasesに公開される
- **バージョン番号**: リリースを一意に識別し変更の性質を示すセマンティックバージョン識別子（例: v1.2.3）
- **カバレッジレポート**: テスト中に収集されCodacyに報告される品質追跡用のテストカバレッジメトリクス
- **GitHub Releaseアセット**: ユーザーがダウンロードできるようGitHub Releaseに添付された個別のファイル（バイナリ、ハッシュ、SBOM）

## 明確化 *(Clarifications)*

### セッション 2026-01-04

- Q: セマンティックバージョニング（major.minor.patch）において、システムはどのようにバージョン番号を自動的にインクリメントしますか？ → A: Conventional Commits（feat:, fix:, BREAKING CHANGE:）に基づいて自動判定
- Q: 1つ以上のプラットフォームでビルドが失敗した場合、システムはどのように対応すべきですか？ → A: 必須プラットフォーム（Windows x64、Linux x64、Mac ARM64）は必須、他（Linux ARM）はオプショナル。必須プラットフォームのいずれかが失敗した場合はリリース全体を失敗させる
- Q: テストカバレッジの最小要件は何ですか?この閾値を下回った場合、mainへのマージはブロックされますか? → A: 80%のカバレッジ閾値を目標とし、低下時は警告を表示するがマージはブロックしない。継続的な品質改善を促進する
- Q: リリースノートはどのように生成されますか？ → A: Conventional Commitsから自動生成（feat/fix/BREAKING CHANGE等でカテゴリ分け）
- Q: リリースされるバイナリファイルの命名規則はどのようにしますか？ → A: 詳細形式「プロジェクト名-バージョン-プラットフォーム-アーキテクチャ」（例: wt-v1.2.3-windows-x64.exe, wt-v1.2.3-linux-x64, wt-v1.2.3-darwin-arm64）
- Q: CycloneDX SBOMのフォーマット（JSON/XML）はどちらを使用しますか？ → A: JSON形式を採用。理由：GitHub Actionsとの統合が容易、ユーザーによる自動解析が一般的、ファイルサイズが小さい## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーはGitHub Releasesページに移動してから2分以内に自分のプラットフォーム向けの動作するバイナリをダウンロードできる
- **SC-002**: 100%のリリースに手動介入なしで完全なファイルハッシュとCycloneDX SBOMファイルが含まれる
- **SC-003**: リリースはmainへのマージから30分以内に人間の介入なしで公開される
- **SC-004**: すべてのバイナリはリリース前に自動テストに合格し、未テストのバイナリがユーザーに届くことはゼロ
- **SC-005**: テストカバレッジはマージ前に100%のブランチに対してCodacyに報告される。プロジェクト全体のカバレッジ目標は80%以上
- **SC-006**: 95%のユーザーが提供されたハッシュファイルを使用して最初の試行でバイナリの完全性を正常に検証できる
- **SC-007**: バージョン番号はセマンティックバージョニングルールに従ってすべてのリリースで一貫してインクリメントされる
- **SC-008**: リリースプロセスでマージから公開まで手動ステップはゼロ
- **SC-009**: 必須プラットフォーム（3つのプラットフォーム: Windows x64、Linux x64、Mac ARM64）が100%のリリースでバイナリを受け取る。オプショナルプラットフォーム（Linux ARM）はベストエフォートベースで提供される
- **SC-010**: ユーザーはセキュリティ監査とコンプライアンスのためにSBOMファイルを通じて完全な依存関係情報にアクセスできる
- **SC-010a**: 100%のリリースでSBOMファイルとSHA256SUMSファイルに検証可能なデジタル署名が含まれ、改ざん検証が可能である
- **SC-011**: 失敗したビルドまたはテストはリリース作成を防ぎ、100%の品質ゲートコンプライアンスを維持する

## 前提条件と依存関係

### 前提条件

- **A-001**: GitHub Actionsはすべてのプラットフォームビルドを同時に処理するのに十分な計算リソースと同時実行制限を持っている
- **A-002**: プロジェクトはConventional Commits規約に従ってコミットメッセージを記述し、セマンティックバージョニング原則を使用している。コミットメッセージ形式: `<type>(<scope>): <subject>`(type: feat, fix, docs, style, refactor, test, chore等)。リリースノートはこれらのコミットから自動生成される
- **A-003**: サポートされているすべてのプラットフォームは、プラットフォーム固有のソースコードブランチなしで単一のコードベースからビルドできる
- **A-004**: すべてのプラットフォームのバイナリサイズはGitHub Releaseアセットのサイズ制限内に収まる（ファイルあたり2GB、リリースあたり10GB）
- **A-005**: ユーザーはGitHub Releasesからのファイルダウンロードとチェックサム検証の基本的な知識を持っている
- **A-006**: ビルドプロセスはリリース前に確実にテストできる決定論的なバイナリを生成する
- **A-007**: CycloneDXツールが利用可能でプロジェクトの依存関係管理システムと互換性がある

### 依存関係

- **D-001**: GitHub Actionsが適切な権限でリポジトリに対して有効化されている必要がある
- **D-002**: GitHub Releases機能がリポジトリで利用可能でアクセス可能である必要がある
- **D-003**: Codacyアカウントがカバレッジレポート用にリポジトリで設定され統合されている必要がある
- **D-004**: すべてのターゲットプラットフォーム向けのビルドツールとコンパイラがGitHubホステッドランナーで利用可能である必要がある
- **D-005**: CycloneDX SBOM生成ツールがプロジェクトの技術スタックで利用可能である必要がある
- **D-006**: mainへのマージ前にテスト成功を強制するマージ保護ルールが設定可能である必要がある
- **D-007**: リポジトリはmainブランチが安定したリリース可能なコードを表す明確なブランチ戦略を持っている必要がある
